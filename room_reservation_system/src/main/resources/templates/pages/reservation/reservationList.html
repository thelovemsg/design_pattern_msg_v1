<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Fee List</title>
</head>
<body>
<div class="m-lg-2">
    <h1>Fee List</h1>
    <a th:href="@{/}">To Home</a>
    <a th:href="@{/fees/new}">Create New Fee</a>
</div>
<div th:if="${successMessage}" class="alert alert-success w-25">
    <p th:text="${successMessage}"></p>
</div>
<div class="m-3">
    <div class="w-75">
        <form>
            <button id="searchButton" class="btn btn-primary mb-3">Search</button>
        </form>
    </div>
    <table id="reservations" class="table table-hover">
        <thead>
        <tr>
            <th class="col-1">Sequence</th>
            <th>Room No</th>
            <th>Reservation Method</th>
            <th>Guest Name</th>
            <th>Guest Tel No</th>
            <th>Reserver Name</th>
            <th>Enter Room Date</th>
            <th>Stay Day Count</th>
            <th>Leave Room Date</th>
            <th>Sales Amount</th>
        </tr>
        </thead>
        <tbody>
        <tr class="table-dark" th:each="fee, iterStat: ${feeList}">
            <td th:text="${iterStat.count + (feeList.number * feeList.size)}">1</td>
            <td><a th:href="@{/fees/update/{id}(id=${fee.id})}" th:text="${fee.feeName}"></a></td>
            <td th:text="${fee.roomTypeCd}" class="w-25">Room Type</td>
            <td th:text="${fee.feeAmount}" class="text-end">Fee Amount</td>
            <td th:text="${fee.remark}">Remark</td>
        </tr>
        </tbody>
    </table>
</div>
<div class="fixed-bottom">
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- 페이지네이션 버튼들이 여기에 추가됩니다 -->
        </ul>
    </nav>
</div>
</body>
<script>
    $(document).ready(function() {
        // 검색 버튼 클릭 이벤트 핸들러
        $('#searchButton').click(function() {
            fetchReservations(); // 페이지네이션 없이 초기 데이터 로드
        });

        function updateTable(data) {
            const tbody = $('#reservations > tbody');
            tbody.empty(); // 기존 테이블 내용 제거

            // 받아온 데이터로 테이블 내용을 채움
            data.forEach(function(reservation, index) {
                tbody.append(
                    `<tr>
                            <td>${index + 1 + (response.data.size * response.data.number)}</td>
                            <td>${reservation.roomNo}</td>
                            <td>${reservation.reservationMethod}</td>
                            <td>${reservation.guestName}</td>
                            <td>${reservation.guestTelno}</td>
                            <td>${reservation.reserverName}</td>
                            <td>${reservation.enterRoomDate}</td>
                            <td>${reservation.stayDayCnt}</td>
                            <td>${reservation.leaveRoomDate}</td>
                            <td>${reservation.salesAmount}</td>
                        </tr>`
                );
            });
        }

        // 페이지네이션 컨트롤을 업데이트하는 함수
        function updatePagination(data) {
            const pagination = $('#pagination');
            pagination.empty(); // 기존 페이지네이션을 초기화

            // 페이지네이션 버튼 생성
            for (let i = 0; i < data.totalPages; i++) {
                const li = $('<li>').addClass('page-item').appendTo(pagination);
                if (i === data.number) {
                    li.addClass('active'); // 현재 페이지 활성화
                }
                $('<a>').addClass('page-link')
                    .attr('href', '#')
                    .text(i + 1)
                    .appendTo(li)
                    .click(function(e) {
                        e.preventDefault();
                        fetchReservations(i); // 클릭된 페이지의 데이터 로드
                    });
            }
        }

        function fetchReservations(page = 0) {
            $.ajax({
                url: '/api/reservations?page=' + page, // 페이지 번호를 URL에 포함
                type: 'GET',
                data: $('#searchForm').serialize(), // 검색 폼 데이터 직렬화
                dataType: 'json',
                success: function(response) {
                    // data가 있고, content가 null이 아닌 경우에만 처리
                    if (response.data && Array.isArray(response.data.content)) {

                        // 페이지네이션 컨트롤을 업데이트
                        updatePagination(response.data);
                    } else {
                        // content가 null 또는 배열이 아닌 경우, 데이터 없음 메시지 표시
                        $('#reservationsTable > tbody').empty().append('<tr><td colspan="10" class="text-center">No data available</td></tr>');
                        $('#pagination').empty(); // 페이지네이션 컨트롤 제거
                    }
                },
                error: function(error) {
                    console.log(error); // 에러 로깅
                    // 에러 발생 시 사용자에게 표시
                    $('#reservationsTable > tbody').empty().append('<tr><td colspan="10" class="text-center">Error fetching data</td></tr>');
                }
            });
        }

        fetchReservations(); // 페이지 로딩 시 초기 데이터 로드
    });
</script>

</html>